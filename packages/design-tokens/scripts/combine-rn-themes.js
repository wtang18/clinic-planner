#!/usr/bin/env node

/**
 * Combine React Native Theme Files
 *
 * Takes the separate light/dark token files generated by Style Dictionary
 * and combines them into single theme files with both lightTokens and darkTokens.
 *
 * Input:  dist/react-native/themes/_pro-light.ts, _pro-dark.ts
 * Output: dist/react-native/themes/pro-tokens.ts
 *
 * Usage: npm run tokens:combine-themes
 */

const fs = require('fs');
const path = require('path');

const themesDir = path.join(__dirname, '../dist/react-native/themes');

// Theme combinations to create
const themes = [
  { name: 'pro', light: '_pro-light.ts', dark: '_pro-dark.ts' },
  { name: 'pro-ehr', light: '_pro-ehr-light.ts', dark: '_pro-ehr-dark.ts' },
  { name: 'pro-billing', light: '_pro-billing-light.ts', dark: '_pro-billing-dark.ts' },
  { name: 'pro-operations', light: '_pro-operations-light.ts', dark: '_pro-operations-dark.ts' },
  { name: 'pro-patient-app', light: '_pro-patient-app-light.ts', dark: '_pro-patient-app-dark.ts' },
  { name: 'consumer', light: '_consumer-light.ts', dark: '_consumer-dark.ts' },
];

function readTokensFromFile(filePath) {
  if (!fs.existsSync(filePath)) {
    console.error(`  ‚ö†Ô∏è  File not found: ${filePath}`);
    return null;
  }

  const content = fs.readFileSync(filePath, 'utf-8');

  // Extract the object content between { and };
  const match = content.match(/= \{([\s\S]*)\};/);
  if (!match) {
    console.error(`  ‚ö†Ô∏è  Could not parse: ${filePath}`);
    return null;
  }

  return match[1].trim();
}

function generateCombinedFile(themeName, lightContent, darkContent) {
  const toPascalCase = (str) =>
    str
      .split('-')
      .map((s) => s.charAt(0).toUpperCase() + s.slice(1))
      .join('');

  const themeDisplayName = toPascalCase(themeName);

  return `/**
 * ${themeDisplayName} Theme Tokens
 *
 * Auto-generated by Style Dictionary. Do not edit manually.
 * Generated: ${new Date().toISOString()}
 *
 * Usage:
 * \`\`\`typescript
 * import { lightTokens, darkTokens, ThemeTokens } from './themes/${themeName}-tokens';
 *
 * // In ThemeProvider, select based on color scheme
 * const tokens = colorScheme === 'dark' ? darkTokens : lightTokens;
 * \`\`\`
 */

export type ThemeTokens = typeof lightTokens;

/**
 * Light Mode Tokens
 * Optimized for light backgrounds with dark text
 */
export const lightTokens = {
${lightContent}
};

/**
 * Dark Mode Tokens
 * Optimized for dark backgrounds with light text
 */
export const darkTokens: ThemeTokens = {
${darkContent}
};
`;
}

function main() {
  console.log('\nüì¶ Combining React Native theme files...\n');

  // Ensure output directory exists
  if (!fs.existsSync(themesDir)) {
    fs.mkdirSync(themesDir, { recursive: true });
  }

  let successCount = 0;

  for (const theme of themes) {
    const lightPath = path.join(themesDir, theme.light);
    const darkPath = path.join(themesDir, theme.dark);
    const outputPath = path.join(themesDir, `${theme.name}-tokens.ts`);

    console.log(`  Combining ${theme.name}...`);

    const lightContent = readTokensFromFile(lightPath);
    const darkContent = readTokensFromFile(darkPath);

    if (!lightContent || !darkContent) {
      console.error(`    ‚ùå Skipped ${theme.name} (missing files)`);
      continue;
    }

    const combined = generateCombinedFile(theme.name, lightContent, darkContent);
    fs.writeFileSync(outputPath, combined);

    // Clean up intermediate files
    fs.unlinkSync(lightPath);
    fs.unlinkSync(darkPath);

    console.log(`    ‚úÖ Created ${theme.name}-tokens.ts`);
    successCount++;
  }

  // Create index file that exports all themes
  const indexContent = `/**
 * React Native Theme Tokens Index
 *
 * Auto-generated. Do not edit manually.
 *
 * Available themes:
 * - pro: Base Pro theme (default)
 * - pro-ehr: Pro with EHR teal accent
 * - pro-billing: Pro with Billing purple accent
 * - pro-operations: Pro with Operations orange accent
 * - pro-patient-app: Pro with Patient App green accent
 * - consumer: Consumer theme (generous spacing, friendly fonts)
 */

// Pro themes
export * as proTheme from './pro-tokens';
export * as proEhrTheme from './pro-ehr-tokens';
export * as proBillingTheme from './pro-billing-tokens';
export * as proOperationsTheme from './pro-operations-tokens';
export * as proPatientAppTheme from './pro-patient-app-tokens';

// Consumer theme
export * as consumerTheme from './consumer-tokens';

// Default export is Pro base
export { lightTokens, darkTokens, ThemeTokens } from './pro-tokens';

// Theme type for runtime selection
export type ProductTheme =
  | 'pro'
  | 'pro-ehr'
  | 'pro-billing'
  | 'pro-operations'
  | 'pro-patient-app'
  | 'consumer';
`;

  fs.writeFileSync(path.join(themesDir, 'index.ts'), indexContent);
  console.log(`    ‚úÖ Created index.ts`);

  console.log(`\n‚úÖ Combined ${successCount}/${themes.length} theme files successfully!`);
  console.log(`\nüìÅ Output: ${themesDir}/\n`);
}

main();
